%h3 Income
- credits = AccountYear.new(account: account, year: year, credits: true)

%table.table.table-account.table-hover
  %thead
    %th
    - credits.months.each do |month|
      %th= month.strftime('%b')
    %th #{year} Total

  %tbody
    - item_category_collection(credits).each do |category_group, categories|
      - next unless categories.present?
      - next if categories.none? { |(name, category_id)| credits.collection[category_id].present? }

      %tr.category-header
        %th{colspan: 14}
          %em= category_group

      - categories.each do |(name, category_id)|
        - next unless (row = credits.collection[category_id])
        %tr
          %td.category= row[0]
          - (1..12).each do |x|
            %td.items= frow(row[x])
          %td.total= frow(row[13].sum(&:amount))

      %tr.category-footer
        %td{colspan: 13}
        %td.total= frow(categories.flat_map { |(name, category_id)| credits.collection[category_id]&.last }.compact.sum(&:amount))

    %tr.category-header
      %td{colspan: 14}

  %tfoot
    - row = credits.totals
    %tr
      %td.category #{year} Total
      - (1..12).each do |x|
        %td.items= frow(row[x].sum(&:amount))
      %td.total= price_to_currency(row[13].sum(&:amount))

%h3 Expenses
- debits = AccountYear.new(account: account, year: year, debits: true)

%table.table.table-account.table-hover
  %thead
    %th
    - debits.months.each do |month|
      %th= month.strftime('%b')
    %th #{year} Total

  %tbody
    - item_category_collection(debits).each_with_index do |(category_group, categories), index|
      - next unless categories.present?
      - next if categories.none? { |(name, category_id)| debits.collection[category_id].present? }

      %tr.category-header
        %th{colspan: 14}
          %em= category_group

      - categories.each do |(name, category_id)|
        - next unless (row = debits.collection[category_id])
        %tr
          %td.category= row[0]
          - (1..12).each do |x|
            %td.items= frow(row[x])
          %td.total= frow(row[13].sum(&:amount))

      %tr.category-footer
        %td{colspan: 13}
        %td.total= frow(categories.flat_map { |(name, category_id)| debits.collection[category_id]&.last }.compact.sum(&:amount))

    %tr.category-header
      %td{colspan: 14}

  %tfoot
    - row = debits.totals
    %tr
      %td.category #{year} Total
      - (1..12).each do |x|
        %td.items= frow(row[x].sum(&:amount))
      %td.total= price_to_currency(row[13].sum(&:amount))


%h3 Summary
- summary = AccountYear.new(account: account, year: year)
- cashflow1 = {}
- cashflow2 = {}

%table.table.table-account.table-hover
  %thead
    %th
    - summary.months.each do |month|
      %th= month.strftime('%b')
    %th #{year} Total

  %tbody

    %tr.category-header
      %th{colspan: 14}
        %em Account Balance

    %tr
      %td.category Balance on last day of month
      - (1..12).each do |x|
        %td.items= frow(summary.balances[x])
      %td.total= frow(summary.balances[12])

    %tr.category-footer
      %td{colspan: 14}

    %tr.category-header
      %th{colspan: 14}
        %em Cash Flow

    %tr
      %td.category Credits minus Debits
      - (1..12).each do |x|
        %td.items
          - cashflow1[x] = credits.totals[x].sum(&:amount) - debits.totals[x].sum(&:amount)
          = frow(cashflow1[x])
      %td.total
        - cashflow1[13] = credits.totals[13].sum(&:amount) - debits.totals[13].sum(&:amount)
        = frow(cashflow1[13])

    %tr
      %td.category Difference in Balance
      %td.items
        - if summary.last_year_balance.present?
          - cashflow2[1] = summary.balances[1] - summary.last_year_balance
          = frow(cashflow2[1])
        - else
          = frow(nil)

      - (2..12).each do |x|
        %td.items
          - if summary.balances[x].present? && summary.balances[x-1].present?
            - cashflow2[x] = summary.balances[x] - summary.balances[x-1]
            = frow(cashflow2[x])
          - else
            = frow(nil)
      %td.total
        - if summary.last_year_balance.present? && summary.balances[12].present?
          - cashflow2[13] = summary.balances[12] - summary.last_year_balance
          = frow(cashflow2[13])
        - else
          = frow(nil)

    %tr
      %td.category Double Check
      - (1..12).each do |x|
        %td.items
          - if cashflow1[x].to_i == 0 || cashflow2[x].to_i == 0
            = frow(nil)
          - elsif cashflow1[x] == cashflow2[x]
            = glyphicon_tag('ok')
          - else
            = glyphicon_tag('remove')

      %td.total
        - if cashflow1[13].to_i == 0 || cashflow2[13].to_i == 0
          = frow(nil)
        - elsif cashflow1[13] == cashflow2[13]
          = glyphicon_tag('ok')
        - else
          = glyphicon_tag('remove')

